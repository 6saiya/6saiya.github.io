(function(e,t,n){var r=qc.defineBehaviour("qc.Plugins.LockOrientation",qc.Behaviour,function(){var e=this;e.orientation=e.game.device.orientation,e.desktop=!1,e.runInEditor=!0,e.manualType=0},{orientation:qc.Serializer.INT,desktop:qc.Serializer.BOOLEAN,manualType:qc.Serializer.INT});r.__menu="Plugins/LockOrientation",t.defineProperties(r.prototype,{orientation:{get:function(){return this._orientation},set:function(e){if(e===this._orientation)return;this._orientation=e,this._doOrientation(this.game.device.orientation)}}}),r.prototype.awake=function(){var e=this,t=e.gameObject;e.addListener(e.game.world.onSizeChange,e._doOrientation,e),e.addListener(t.parent.onRelayout,e.assureSize,e),e._doOrientation(),e.assureSize();var n=t.parent.getScript("qc.ScaleAdapter");if(n){var r=n.getReferenceResolution;n.getReferenceResolution=function(){var t=r.call(this);return e.rotate90?new qc.Point(t.y,t.x):t}}},r.prototype.assureSize=function(){var e=this,t=e.gameObject,n=t.parent.rect;e.rotate90===!0?(t.width=n.height,t.height=n.width):(t.width=n.width,t.height=n.height),t.setAnchor(new qc.Point(.5,.5),new qc.Point(.5,.5)),t.anchoredX=0,t.anchoredY=0,t.pivotX=.5,t.pivotY=.5},r.prototype._doOrientation=function(){var e=this,t=e.gameObject,n=e.game.device.orientation;if(!e.desktop&&!e.game.editor&&e.game.device.desktop){t.rotation=0,e.rotate90=!1;return}switch(e.orientation){case qc.Device.AUTO:default:t.rotation=0,e.rotate90=!1;return;case qc.Device.PORTRAIT:case qc.Device.LANDSCAPE:n===e.orientation?(t.rotation=0,e.rotate90=!1):(t.rotation=-Math.PI/2,e.rotate90=!0),e.assureSize()}var r=t.parent.getScript("qc.ScaleAdapter");r&&(e.rotate90?e.manualType===qc.ScaleAdapter.MANUAL_WIDTH?r.manualType=qc.ScaleAdapter.MANUAL_HEIGHT:e.manualType===qc.ScaleAdapter.MANUAL_HEIGHT?r.manualType=qc.ScaleAdapter.MANUAL_WIDTH:r.manualType=e.manualType:r.manualType=e.manualType)};var i=qc.defineBehaviour("qc.Plugins.NodeFadeInOut",qc.Tween,function(){this.fadeType=i.FADE_IN,this.columnCount=1,this.rowCount=1,this.pivotX=.5,this.pivotY=.5,this.fadeStyle=i.STYLE_ZOOM,this.fadeEffect=i.EFFECT_XY,this.target=null},{fadeType:qc.Serializer.NUMBER,columnCount:qc.Serializer.NUMBER,rowCount:qc.Serializer.NUMBER,pivotX:qc.Serializer.NUMBER,pivotY:qc.Serializer.NUMBER,fadeStyle:qc.Serializer.NUMBER,fadeEffect:qc.Serializer.NUMBER,target:qc.Serializer.NODE});i.__menu="Plugins/NodeFadeInOut",t.defineProperties(i.prototype,{columnCount:{get:function(){return this._columnCount},set:function(e){e=isNaN(e)||e===0?1:e;if(e===this._columnCount)return;this._columnCount=e}},rowCount:{get:function(){return this._rowCount},set:function(e){e=isNaN(e)||e===0?1:e;if(e===this._rowCount)return;this._rowCount=e}},_cachedTarget:{get:function(){return this.target&&this.target._destroy&&(this.target=null),this.target||this.gameObject}}}),i.prototype.onEnable=function(){var e=this;if(e._cachedTarget._destroy)return;e._cachedTarget.visible=!0,e._cachedTexture&&(e._cachedTexture.destroy(!0),e._cachedTexture=null),e._cachedBounds=e._cachedTarget.localBounds,e._cachedTexture=e._cachedTarget.generateTexture(),e._cachedSprite=new PIXI.Sprite(e._cachedTexture),e._cachedSprite.worldTransform=e._cachedTarget.worldTransform,e._cachedTarget.phaser.anchor&&(e._cachedSprite.anchor=e._cachedTarget.phaser.anchor),e._nodeRenderCanvas||(e._nodeRenderCanvas=e.gameObject.phaser._renderCanvas,e.gameObject.phaser._renderCanvas=e.renderCanvas.bind(this),e.gameObject.phaser.getSelfWidth=function(){return e._cachedSprite.width},e.gameObject.phaser.getSelfHeight=function(){return e._cachedSprite.height},e.gameObject.phaser._skipChildrenRender=!0),e._nodeRenderWebGL||(e._nodeRenderWebGL=e.gameObject.phaser._renderWebGL,e.gameObject.phaser._renderWebGL=e.renderWebGL.bind(this))},i.prototype.onDisable=function(){this._nodeRenderCanvas&&(this.gameObject.phaser._renderCanvas=this._nodeRenderCanvas,this._nodeRenderCanvas=null),this._nodeRenderWebGL&&(this.gameObject.phaser._renderWebGL=this._nodeRenderWebGL,this._nodeRenderWebGL=null,this.gameObject.phaser.getSelfWidth=null,this.gameObject.phaser.getSelfHeight=null,this.gameObject.phaser._skipChildrenRender=!1),this._cachedTexture&&(this._cachedTexture.destroy(!0),this._cachedTexture=null),this._cachedSprite&&(this._cachedSprite=null),qc.Tween.prototype.onDisable.call(this)},i.prototype.onDestroy=function(){this._nodeRenderCanvas&&(this.gameObject.phaser._renderCanvas=this._nodeRenderCanvas,this._nodeRenderCanvas=null),this._nodeRenderWebGL&&(this.gameObject.phaser._renderWebGL=this._nodeRenderWebGL,this._nodeRenderWebGL=null),this._cachedTexture&&(this._cachedTexture.destroy(!0),this._cachedTexture=null),this._cachedSprite&&(this._cachedSprite=null),qc.Tween.prototype.onDestroy&&qc.Tween.prototype.onDestroy.call(this)},i.prototype.onUpdate=function(e,t){this._factorValue=this.fadeType===i.FADE_IN?1-e:e,this.gameObject.phaser.displayChanged(qc.DisplayChangeStatus.TEXTURE|qc.DisplayChangeStatus.SIZE),t&&!this._cachedTarget._destroy&&this._cachedTarget===this.gameObject&&(this._cachedTarget.visible=this.fadeType===i.FADE_IN)},i.prototype.renderCanvas=function(e){this._cachedTarget!==this.gameObject&&this._nodeRenderCanvas.call(this.gameObject.phaser,e);var t=this._cachedTexture,n=this._cachedSprite,r=this._cachedBounds;if(t){var s=t.baseTexture.resolution/e.resolution;e.context.globalAlpha=n.worldAlpha,e.smoothProperty&&e.scaleMode!==t.baseTexture.scaleMode&&(e.scaleMode=t.baseTexture.scaleMode,e.context[e.smoothProperty]=e.scaleMode===PIXI.scaleModes.LINEAR);var o=t.trim?t.trim.x-n.anchor.x*t.trim.width:n.anchor.x*-t.frame.width,u=t.trim?t.trim.y-n.anchor.y*t.trim.height:n.anchor.y*-t.frame.height;e.roundPixels?(e.context.setTransform(n.worldTransform.a,n.worldTransform.b,n.worldTransform.c,n.worldTransform.d,n.worldTransform.tx*e.resolution|0,n.worldTransform.ty*e.resolution|0),o|=0,u|=0):e.context.setTransform(n.worldTransform.a,n.worldTransform.b,n.worldTransform.c,n.worldTransform.d,n.worldTransform.tx*e.resolution,n.worldTransform.ty*e.resolution);var a=t.crop.width/this.columnCount,f=t.crop.height/this.rowCount,l=this.fadeEffect===i.EFFECT_X||this.fadeEffect===i.EFFECT_XY,c=this.fadeEffect===i.EFFECT_Y||this.fadeEffect===i.EFFECT_XY,h=(l?1-this._factorValue:1)*a/s,p=(c?1-this._factorValue:1)*f/s,d=l&&this.fadeStyle===i.STYLE_CLIP?a*(1-this._factorValue):a,v=c&&this.fadeStyle===i.STYLE_CLIP?f*(1-this._factorValue):f;for(var m=0;m<t.crop.height;m+=f){var g=(u+m+f*(c?this._factorValue:0)*this.pivotY)/s+r.y;for(var y=0;y<t.crop.width;y+=a){var b=(o+y+a*(l?this._factorValue:0)*this.pivotX)/s+r.x;e.context.drawImage(t.baseTexture.source,t.crop.x+y,t.crop.y+m,d,v,b,g,h,p)}}}},i.prototype.renderWebGL=function(e){this._cachedTarget!==this.gameObject&&this._nodeRenderWebGL.call(this.gameObject.phaser,e);var t=this._cachedTexture,n=this._cachedBounds,r=this._cachedSprite,s=t._uvs;if(!s)return;var o=t.baseTexture.resolution/e.resolution,u=t.crop.width/this.columnCount,a=t.crop.height/this.rowCount,f=this.fadeEffect===i.EFFECT_X||this.fadeEffect===i.EFFECT_XY,l=this.fadeEffect===i.EFFECT_Y||this.fadeEffect===i.EFFECT_XY,c=(f?1-this._factorValue:1)*u/o,h=(l?1-this._factorValue:1)*a/o,p=f&&this.fadeStyle===i.STYLE_CLIP?u*(1-this._factorValue):u,d=l&&this.fadeStyle===i.STYLE_CLIP?a*(1-this._factorValue):a,v=r.worldTransform,m=v.a/o,g=v.b/o,y=v.c/o,b=v.d/o,w=v.tx,E=v.ty,S=s.x2-s.x0,x=s.y2-s.y0;for(var T=0;T<t.crop.height;T+=a){var N=(T+a*(l?this._factorValue:0)*this.pivotY)/o+n.y;for(var C=0;C<t.crop.width;C+=u){var k=(C+u*(f?this._factorValue:0)*this.pivotX)/o+n.x;this._webGLAddQuad(e.spriteBatch,r,k,N,k+c,N+h,s.x0+S*C/t.crop.width,s.y0+x*T/t.crop.height,s.x0+S*(C+p)/t.crop.width,s.y0+x*(T+d)/t.crop.height,m,g,y,b,w,E,r.tint)}}},i.prototype._webGLAddQuad=function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){e.currentBatchSize>=e.size&&(e.flush(),e.currentBaseTexture=t.texture.baseTexture);var g=e.colors,y=e.positions,b=e.currentBatchSize*4*e.vertSize;e.renderSession.roundPixels?(y[b]=l*n+h*r+d|0,y[b+1]=p*r+c*n+v|0,y[b+5]=l*i+h*r+d|0,y[b+6]=p*r+c*i+v|0,y[b+10]=l*i+h*s+d|0,y[b+11]=p*s+c*i+v|0,y[b+15]=l*n+h*s+d|0,y[b+16]=p*s+c*n+v|0):(y[b]=l*n+h*r+d,y[b+1]=p*r+c*n+v,y[b+5]=l*i+h*r+d,y[b+6]=p*r+c*i+v,y[b+10]=l*i+h*s+d,y[b+11]=p*s+c*i+v,y[b+15]=l*n+h*s+d,y[b+16]=p*s+c*n+v),y[b+2]=o,y[b+3]=u,y[b+7]=a,y[b+8]=u,y[b+12]=a,y[b+13]=f,y[b+17]=o,y[b+18]=f,g[b+4]=g[b+9]=g[b+14]=g[b+19]=(m>>16)+(m&65280)+((m&255)<<16)+(t.worldAlpha*255<<24),e.sprites[e.currentBatchSize++]=t},i.FADE_IN=0,i.FADE_OUT=1,i.STYLE_ZOOM=0,i.STYLE_CLIP=1,i.EFFECT_XY=0,i.EFFECT_X=1,i.EFFECT_Y=2;var s=qc.defineBehaviour("qc.demo.Init",qc.Behaviour,function(){},{});s.prototype.awake=function(){this.game.assets.load("defaultFont","Assets/font/desyrel.bin"),this.game.G||(this.game.G={})};var o=qc.defineBehaviour("qc.demo.Animal",qc.Behaviour,function(){var e=this;e.type=0,e.index=0,e.explode=null},{icon:qc.Serializer.NODE,explode:qc.Serializer.NODE});o.prototype.setData=function(e){var t=this;t.icon.frame=e.icon,t.type=e.type,t.index=e.index,t.name=""+t.index},o.prototype.disappear=function(e){var t=this;t.icon.visible=!1,t.explode.visible=!0,t.explode.onFinished.addOnce(function(){t.explode.visible=!1,e()}),t.explode.playAnimation("explode")},o.prototype.drop=function(e,t,n,r){var i=this;i.icon.frame=t,i.type=e,i.icon.visible=!0;var s=i.getScript("qc.TweenPosition");s.from=new qc.Point((n+64)%8*76,i.game.math.floorTo(n/8)*72),s.to=new qc.Point(i.index%8*76,i.game.math.floorTo(i.index/8)*72),s.duration=(s.to.y-s.from.y)/72*.13,s.resetToBeginning(),s.onFinished.addOnce(function(){r()}),s.playForward()};var u=qc.defineBehaviour("qc.demo.LoadingUI",qc.Behaviour,function(){this.clue=null},{clue:qc.Serializer.NODE});u.prototype.awake=function(){var e=this;this.addListener(e.game.scene.onStartLoad,function(){e.show()}),this.addListener(e.game.scene.onEndLoad,function(){e.gameObject.visible&&(e.duringTween?e.nextChange=1:e.hide())})},u.prototype.update=function(){var e=this,t=e.game.assets.loaded,n=e.game.assets.total;n?e.clue.text="拼命加载中："+t+"/"+n:e.clue.text="",e.gameObject.parent.setChildIndex(this.gameObject,e.gameObject.parent.children.length-1)},u.prototype.show=function(){var e=this,t=e.gameObject.getScript("qc.Plugins.NodeFadeInOut");e.gameObject.visible=!0,e.gameObject.alpha=0,t.stop(),t.enable=!1,t.target=e.gameObject.game.world,t.fadeType=i.FADE_OUT,t.fadeStyle=this.getRandomInt(0,2),t.fadeEffect=this.getRandomInt(0,3),t.pivotX=Math.random(0,1),t.pivotY=Math.random(0,1),t.columnCount=this.getRandomInt(1,32),t.rowCount=this.getRandomInt(1,32),t.resetToBeginning(),t.playForward(),e.gameObject.alpha=1,e.duringTween=!0,t.onFinished.addOnce(function(){e.duringTween=!1,e.nextChange&&(e.hide(),e.nextChange=0)})},u.prototype.hide=function(){var e=this,t=e.gameObject.getScript("qc.Plugins.NodeFadeInOut");e.gameObject.alpha=1,t.enable=!1,t.target=null,t.fadeType=i.FADE_OUT,t.fadeStyle=this.getRandomInt(0,2),t.fadeEffect=this.getRandomInt(0,3),t.pivotX=Math.random(0,1),t.pivotY=Math.random(0,1),t.columnCount=this.getRandomInt(1,32),t.rowCount=this.getRandomInt(1,32),t.resetToBeginning(),t.playForward(),e.duringTween=!0,t.onFinished.addOnce(function(){e.gameObject.visible=!1,e.duringTween=!1,e.nextChange=0})},u.prototype.getRandomInt=function(e,t){return Math.floor(Math.random()*(t-e))+e};var a=qc.defineBehaviour("qc.demo.SourcesUI",qc.Behaviour,function(){var e=this;e.icons=["bear.png","owl.png","fox.png","hippopotamus.png","frog.png","chicken.png"],e.grids=[0,2,1,1,0,0,1,0,1,0,2,2,0,0,1,0,0,0,1,0,1,2,0,1,1,1,2,1,2,2,1,2,0,0,1,0,1,0,0,4,1,0,1,1,3,1,1,3,0,1,0,1,1,2,2,1,0,0,1,0,0,2,1,1],e.gridPrefab=null,e._animations=[],e.score=0,e.W=76,e.H=72,e.scoreLabel=null,e.explodeAudio=null},{gridPrefab:qc.Serializer.PREFAB,scoreLabel:qc.Serializer.NODE,explodeAudio:qc.Serializer.AUDIO});t.defineProperties(a.prototype,{score:{get:function(){return this._score||0},set:function(e){this._score=e,this.scoreLabel&&(this.scoreLabel.text=""+e)}}}),a.prototype.awake=function(){this.resetGame()},a.prototype.resetGame=function(){var e=this;e.score=0,e.gameObject.removeChildren(),e._animations=[];for(var t=0;t<e.grids.length;t++){var n=e.game.add.clone(e.gridPrefab,e.gameObject);n.x=t%8*this.W,n.y=e.game.math.floorTo(t/8)*this.H;var r=n.getScript("qc.demo.Animal");r.setData({index:t,icon:e.icons[e.grids[t]],type:e.grids[t]}),e._animations.push(r)}},a.prototype.onDragStart=function(e){if(this._switch)return;var t=e.source,n=new qc.Point(t.x,t.y),r=this.gameObject.toLocal(n);this._dragIndex=this.toIndex(r.x,r.y),this._dragging=!0,this.game.log.trace("开始拖拽: {0}",this._dragIndex)},a.prototype.onDrag=function(e){if(!this._dragging)return;var t=e.source,n=new qc.Point(t.x,t.y),r=this.gameObject.toLocal(n),i=this.toIndex(r.x,r.y);if(i===this._dragIndex)return;this._dragging=!1;var s=this.getRelation(this._dragIndex,i);if(!s){this.game.log.trace("强制取消拖拽: {0}",i);return}this.switch(i,this._dragIndex)},a.prototype.onDragEnd=function(e){this.game.log.trace("拖拽结束"),this._dragging=!1},a.prototype.toIndex=function(e,t){var n=8,r=this.game.math.floorTo(e/this.W),i=this.game.math.floorTo(t/this.H);return i*n+r},a.prototype.getRelation=function(e,t){var n=8,r=e%n,i=this.game.math.floorTo(e/n),s=t%n,o=this.game.math.floorTo(t/n);if(r+1===s&&i===o)return"left";if(r-1===s&&i===o)return"right";if(r===s&&i+1===o)return"top";if(r===s&&i-1===o)return"bottom"},a.prototype.switch=function(e,t){var n=this;n._switch=!0;var r=n.grids.concat(),i=r[e];r[e]=r[t],r[t]=i;var s=qc.demo.SourcesUtil.findResult(r),o=2,u=n._animations[e].gameObject,a=n._animations[t].gameObject,f=function(){n.moveGrid(a,t,function(){n._switch=!1}),n.moveGrid(u,e,function(){n._switch=!1})},l=function(){if(s.length<1)n.game.log.trace("无效的移动"),f();else{n.grids=r;var i=n._animations[e];n._animations[e]=n._animations[t],n._animations[t]=i,n._animations[e].index=e,n._animations[t].index=t,n.game.log.trace("开始播放消除动画"),n.disappear(s)}},c=function(){o--,o<=0&&l()};n.moveGrid(u,t,c),n.moveGrid(a,e,c)},a.prototype.moveGrid=function(e,t,n){var r=this,i=e.getScript("qc.TweenPosition");i.from=new qc.Point(e.x,e.y),i.to=new qc.Point(t%8*this.W,this.game.math.floorTo(t/8)*this.H),i.duration=.3,i.onFinished.addOnce(function(){n&&r.game.timer.add(1,n)}),i.resetToBeginning(),i.playForward()},a.prototype.disappear=function(e){var t=this,n=0,r=0,i=t.game.add.sound();i.audio=t.explodeAudio,i.play();var s=function(){--n<=0&&t.addAnimations()};for(var o in e){var u=e[o];r+=2+(u.length-3)*2,t.score+=r;for(var a in u){var f=u[a];t.grids[f]=-1,n++,t._animations[f].disappear(s)}}},a.prototype.addAnimations=function(){var e=this,t=0,n=function(){if(--t<=0){var n=qc.demo.SourcesUtil.findResult(e.grids);n.length===0?e._switch=!1:e.disappear(n)}};for(var r=0;r<8;r++){var i=0;for(var s=7;s>=0;s--){var o=r+s*8,u=e.grids[o];if(u===-1){i++;continue}if(i===0)continue;t++,e.grids[o+8*i]=u,e.game.log.trace("drop: {0} -> {1}",o,o+8*i),e._animations[o+8*i].drop(u,e.icons[u],o,n)}for(var a=0;a<i;a++){var u=e.game.math.random(0,2);t++,e.grids[a*8+r]=u,e.game.log.trace("drop: {0} -> {1}",(a-i)*8+r,a*8+r),e._animations[a*8+r].drop(u,e.icons[u],(a-i)*8+r,n)}}};var f=qc.demo.SourcesUtil={};f.findResult=function(e,t,n,r){var i,s=[],o,u,a,f,l,c,h,p,d,v,m,g,y,b,w=[],E;t=t||8,n=n||8,r=r||3;var S=function(e,n){return e*t+n};for(o=0;o<n;o++){s.push([]);for(u=0;u<t;u++)s[o].push({type:e[S(o,u)]})}for(o=0;o<n;o++){h=-1;for(u=0;u<=t;u++){d=s[o][u]||{},p=d.type;if(p!==h){for(a=u-1;a>=0;a--){if(s[o][a].type!==h)break;s[o][a].hc=c}c=1,h=p}else c++}}for(u=0;u<t;u++){h=-1;for(o=0;o<=n;o++){d=o==n?{}:s[o][u],p=d.type;if(p!==h){for(a=o-1;a>=0;a--){if(s[a][u].type!==h)break;s[a][u].vc=c}c=1,h=p}else c++}}for(o=0;o<n;o++)for(u=0;u<t;u++){d=s[o][u];if(d.hc<r&&d.vc<r)continue;if(d.visited)continue;i=[],E=[S(o,u)],i.push([o,u]),d.visited=!0,f=0,l=1,p=d.type;while(f<l)v=i[f][0],m=i[f][1],f++,[[-1,0],[1,0],[0,-1],[0,1]].forEach(function(e){g=v+e[0],y=m+e[1];if(!s[g])return;if(!(b=s[g][y]))return;if(b.visited||b.type!==p||b.hc<r&&b.vc<r)return;i.push([g,y]),l++,b.visited=!0,E.push(S(g,y))});w.push(E)}return w}}).call(this,this,Object)